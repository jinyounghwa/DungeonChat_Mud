generator client {
  provider = "prisma-client"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Users table
model User {
  id        String     @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  username  String     @unique @db.VarChar(50)
  email     String     @unique @db.VarChar(255)
  passwordHash String   @db.VarChar(255)
  createdAt DateTime   @default(now())
  lastLogin DateTime   @default(now())

  // Relations
  characters Character[]

  @@index([username])
  @@index([email])
}

// Characters table
model Character {
  id           String     @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId       String     @db.Uuid
  name         String     @db.VarChar(50)
  class        String     @db.VarChar(20) // warrior, mage, thief
  level        Int        @default(1)
  exp          Int        @default(0)
  hp           Int
  maxHp        Int
  atk          Int
  def          Int
  currentFloor Int        @default(1)
  gold         Int        @default(0)
  isActive     Boolean    @default(true)
  createdAt    DateTime   @default(now())
  updatedAt    DateTime   @updatedAt

  // Relations
  user         User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  inventory    Inventory[]
  battleLogs   BattleLog[]
  conversations Conversation[]
  saveStates   SaveState[]

  @@index([userId])
  @@index([isActive])
}

// Inventory table
model Inventory {
  id           String     @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  characterId  String     @db.Uuid
  itemName     String     @db.VarChar(100)
  itemType     String     @db.VarChar(50) // potion, weapon, armor, accessory, material
  quantity     Int        @default(1)
  statsBonus   Json       @default("{}")
  isEquipped   Boolean    @default(false)
  createdAt    DateTime   @default(now())

  // Relations
  character    Character  @relation(fields: [characterId], references: [id], onDelete: Cascade)

  @@index([characterId])
  @@index([itemType])
}

// Battle logs table
model BattleLog {
  id           String     @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  characterId  String     @db.Uuid
  monsterName  String     @db.VarChar(100)
  monsterLevel Int
  result       String     @db.VarChar(20) // victory, defeat, escape
  damageDealt  Int        @default(0)
  damageTaken  Int        @default(0)
  expGained    Int        @default(0)
  goldGained   Int        @default(0)
  itemsGained  Json       @default("[]")
  battleDuration Int?     // number of turns
  createdAt    DateTime   @default(now())

  // Relations
  character    Character  @relation(fields: [characterId], references: [id], onDelete: Cascade)

  @@index([characterId])
  @@index([createdAt])
}

// Conversations table
model Conversation {
  id           String     @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  characterId  String     @db.Uuid
  role         String     @db.VarChar(20) // user, assistant, system
  content      String     @db.Text
  metadata     Json       @default("{}")
  createdAt    DateTime   @default(now())

  // Relations
  character    Character  @relation(fields: [characterId], references: [id], onDelete: Cascade)

  @@index([characterId])
  @@index([createdAt])
}

// Save states table
model SaveState {
  id           String     @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  characterId  String     @db.Uuid
  slotNumber   Int
  saveName     String?    @db.VarChar(100)
  gameState    Json
  screenshotUrl String?   @db.Text
  createdAt    DateTime   @default(now())
  updatedAt    DateTime   @updatedAt

  // Relations
  character    Character  @relation(fields: [characterId], references: [id], onDelete: Cascade)

  @@unique([characterId, slotNumber])
  @@index([characterId])
}
